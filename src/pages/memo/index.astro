---
import Layout from "../../layouts/Layout.astro";

const MEMO_API = "https://memo.cattk.com/api/broadcast";
const res = await fetch(MEMO_API);
const memos = (await res.json()) || [];
---

<Layout title="Memos">
  <div class="mx-auto max-w-3xl px-4 py-10">
    <h1 class="text-3xl font-bold mb-6">Memos</h1>

    <div class="grid gap-4">
      {memos.map((memo) => (
        <div
          class="p-4 rounded-lg border border-gray-200 bg-white shadow-sm dark:bg-gray-900 dark:border-gray-700"
        >
          <div class="text-sm text-gray-500 mb-2">
            {new Date(memo.created_at).toLocaleString()}
          </div>

          <div class="prose prose-sm dark:prose-invert mb-3">
            {memo.content}
          </div>

          {memo.images && memo.images.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {memo.images.map((img) => (
                <img
                  src={img}
                  class="w-32 h-32 object-cover rounded cursor-pointer memo-img"
                  data-full={img}
                />
              ))}
            </div>
          )}
        </div>
      ))}
    </div>
  </div>

  <!-- Lightbox -->
  <div
    id="lightbox"
    class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50"
  >
    <img id="lightbox-img" src="" class="max-w-[90%] max-h-[90%] rounded shadow-lg" />
  </div>

  <style>
    #lightbox.show {
      display: flex;
    }
  </style>

  <script is:inline>
    // -------------------------------
    // 图片预览 Lightbox
    // -------------------------------
    document.addEventListener("DOMContentLoaded", () => {
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox-img");

      if (!lightbox || !lightboxImg) return;

      const imgs = document.querySelectorAll<HTMLImageElement>(".memo-img");

      imgs.forEach((img) => {
        img.addEventListener("click", () => {
          const url = img.dataset.full;
          if (url) {
            lightboxImg.src = url;
            lightbox.classList.add("show");
          }
        });
      });

      // 点击关闭
      lightbox.addEventListener("click", () => {
        lightboxImg.src = "";
        lightbox.classList.remove("show");
      });
    });
  </script>
</Layout>