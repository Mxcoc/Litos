---
import Layout from "~/layouts/Layout.astro"

const rssUrl = "https://memo.cattk.com/rss.json"

interface MemoItem {
  id?: string
  content_html: string
  date_published: string
}

let memos: MemoItem[] = []

try {
  const res = await fetch(rssUrl)
  const data = await res.json()
  memos = data?.items || []
} catch (e) {
  console.error("加载 Memos 数据失败:", e)
}

/** 提取 content_html 中的所有图片 URL */
function getImagesFromHtml(html: string): string[] {
  const regex = /<img[^>]+src="([^">]+)"/g
  const images: string[] = []
  let match

  while ((match = regex.exec(html)) !== null) {
    images.push(match[1])
  }

  return images
}
---

<Layout title="Memos" description="我的日常想法与记录">
  <main class="memo-container">
    <h1 class="page-title">Memos</h1>

    {memos.map((item: MemoItem) => {
      const images = getImagesFromHtml(item.content_html)

      return (
        <article class="memo-card" id={`memo-${item.id || item.date_published}`}>
          <div class="memo-content" set:html={item.content_html}></div>

          {images.length > 0 && (
            <div class="memo-images">
              {images.map((url: string) => (
                <img
                  src={url}
                  loading="lazy"
                  class="memo-img"
                  onclick={`zoomImage('${url}')`}
                />
              ))}
            </div>
          )}

          <time class="memo-time">
            {new Date(item.date_published).toLocaleString()}
          </time>
        </article>
      )
    })}
  </main>

  <!-- 图片预览 Lightbox -->
  <div id="zoom-overlay" class="zoom-overlay" onclick="closeZoom()">
    <img id="zoom-img" class="zoom-img" />
  </div>

  <script>
    function zoomImage(url) {
      const overlay = document.getElementById("zoom-overlay")
      const img = document.getElementById("zoom-img")

      if (img) img.src = url
      if (overlay) overlay.style.display = "flex"
    }

    function closeZoom() {
      const overlay = document.getElementById("zoom-overlay")
      if (overlay) overlay.style.display = "none"
    }
  </script>

  <style>
    .memo-container {
      max-width: 780px;
      margin: 0 auto;
      padding: 20px;
    }

    .page-title {
      font-size: 2rem;
      margin-bottom: 20px;
    }

    .memo-card {
      background: var(--card-bg, #fff);
      border: 1px solid var(--divider-color, #e5e5e5);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow, 0 1px 4px rgba(0, 0, 0, 0.04));
    }

    .memo-content {
      line-height: 1.8;
      margin-bottom: 12px;
    }

    .memo-images {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .memo-img {
      width: 100%;
      border-radius: 8px;
      object-fit: cover;
      cursor: zoom-in;
      transition: opacity 0.2s;
    }

    .memo-img:hover {
      opacity: 0.85;
    }

    .memo-time {
      color: var(--text-secondary, #666);
      font-size: 0.85rem;
    }

    /* Lightbox */
    .zoom-overlay {
      position: fixed;
      z-index: 9999;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .zoom-img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      object-fit: contain;
    }
  </style>
</Layout>