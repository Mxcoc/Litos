---
import Layout from '~/layouts/Layout.astro'

const rssUrl = "https://memo.cattk.com/rss.json"

// 定义 BroadcastChannel RSS Item 类型
type MemoItem = {
  content_html: string
  date_published: string
  id?: string
  title?: string
}

let memos: MemoItem[] = []
try {
  const res = await fetch(rssUrl)
  const data = await res.json()
  memos = (data?.items || []) as MemoItem[]
} catch (e) {
  console.error("无法获取 Memos 数据:", e)
}

const relativeTimeScript = `
function timeAgo(dateString) {
  const date = new Date(dateString)
  const now = new Date()
  const diff = (now - date) / 1000

  if (diff < 60) return '刚刚'
  if (diff < 3600) return Math.floor(diff / 60) + ' 分钟前'
  if (diff < 86400) return Math.floor(diff / 3600) + ' 小时前'
  if (diff < 172800) return '昨天'
  if (diff < 604800) return Math.floor(diff / 86400) + ' 天前'

  return date.toLocaleString()
}

document.querySelectorAll('[data-time]').forEach(el => {
  el.textContent = timeAgo(el.getAttribute('data-time'))
})
`
---

<Layout title="Memos" description="Memos Timeline">
  <main class="memos-container">
    <h1>Memos</h1>

    {memos.length === 0 && <p>无法加载内容。</p>}

    {memos.map((item: MemoItem) => (
      <article class="memo-item">
        <p class="memo-content" set:html={item.content_html}></p>

        <div class="memo-meta">
          <span class="memo-time" data-time={item.date_published}>
            {new Date(item.date_published).toLocaleString()}
          </span>
        </div>
      </article>
    ))}
  </main>

  <script is:inline>{relativeTimeScript}</script>
</Layout>

<style>
  .memos-container {
    max-width: 740px;
    margin: 0 auto;
    padding: 20px;
  }

  h1 {
    margin-bottom: 24px;
    font-size: 2rem;
    font-weight: 600;
  }

  .memo-item {
    padding: 18px 0;
    border-bottom: 1px solid var(--divider-color, #e5e5e5);
  }

  .memo-content {
    line-height: 1.75;
    font-size: 1rem;
    white-space: pre-wrap;
    color: var(--text-primary, #333);
    margin-bottom: 10px;
  }

  .memo-meta {
    font-size: 0.85rem;
    color: var(--text-secondary, #888);
  }

  :root.dark .memo-item {
    border-color: #3a3a3a;
  }
  :root.dark .memo-content {
    color: #ddd;
  }
  :root.dark .memo-meta {
    color: #aaa;
  }
</style>
